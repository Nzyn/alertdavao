<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 1400" style="background:#f8f9fa">
  <!-- Title -->
  <text x="600" y="40" font-family="Arial, sans-serif" font-size="28" font-weight="bold" text-anchor="middle" fill="#1a1a1a">
    AlertDavao Actual Encryption Architecture (AES-256-CBC)
  </text>
  
  <!-- Section 1: User Upload Flow -->
  <g id="upload-section">
    <!-- User Circle -->
    <circle cx="120" cy="150" r="50" fill="#3b82f6" stroke="#1e40af" stroke-width="3"/>
    <text x="120" y="160" font-family="Arial" font-size="16" fill="white" text-anchor="middle" font-weight="bold">Citizen</text>
    
    <!-- Arrow to Node Server -->
    <path d="M 170 150 L 260 150" stroke="#374151" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>
    <text x="215" y="140" font-family="Arial" font-size="13" fill="#374151">HTTPS</text>
    <text x="200" y="170" font-family="Arial" font-size="11" fill="#6b7280">Plaintext File</text>
    
    <!-- Node.js Server -->
    <rect x="280" y="100" width="280" height="250" rx="12" fill="#fff" stroke="#3b82f6" stroke-width="3"/>
    <text x="420" y="130" font-family="Arial" font-size="18" font-weight="bold" text-anchor="middle" fill="#1e40af">Node.js Backend Server</text>
    
    <!-- APP_KEY Box -->
    <rect x="300" y="150" width="240" height="50" rx="6" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
    <text x="420" y="170" font-family="Arial" font-size="12" font-weight="bold" text-anchor="middle" fill="#92400e">üîë APP_KEY</text>
    <text x="420" y="188" font-family="Arial" font-size="11" text-anchor="middle" fill="#78350f">(from .env file - never sent)</text>
    
    <!-- Encrypt File Box -->
    <rect x="300" y="210" width="240" height="60" rx="6" fill="#a7f3d0" stroke="#059669" stroke-width="2"/>
    <text x="420" y="230" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#065f46">Encrypt File</text>
    <text x="420" y="248" font-family="Arial" font-size="11" text-anchor="middle" fill="#047857">AES-256-CBC</text>
    <text x="420" y="262" font-family="Arial" font-size="10" text-anchor="middle" fill="#047857">encryptFile(buffer)</text>
    
    <!-- Encrypt Text Box -->
    <rect x="300" y="280" width="240" height="60" rx="6" fill="#a7f3d0" stroke="#059669" stroke-width="2"/>
    <text x="420" y="300" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#065f46">Encrypt Text Data</text>
    <text x="420" y="318" font-family="Arial" font-size="11" text-anchor="middle" fill="#047857">Description, Location</text>
    <text x="420" y="332" font-family="Arial" font-size="10" text-anchor="middle" fill="#047857">encrypt(text)</text>
    
    <!-- Arrow to Storage -->
    <path d="M 560 225 L 680 225" stroke="#374151" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>
    <text x="620" y="215" font-family="Arial" font-size="11" fill="#374151">Encrypted</text>
    <text x="620" y="245" font-family="Arial" font-size="11" fill="#6b7280">Ciphertext</text>
  </g>
  
  <!-- Section 2: Storage -->
  <g id="storage-section">
    <!-- File Storage -->
    <rect x="700" y="80" width="200" height="140" rx="8" fill="#1f2937" stroke="#111827" stroke-width="3"/>
    <text x="800" y="110" font-family="Arial" font-size="16" font-weight="bold" text-anchor="middle" fill="#fff">Private Storage</text>
    <text x="800" y="135" font-family="Arial" font-size="12" text-anchor="middle" fill="#9ca3af">üîí Encrypted Files</text>
    
    <circle cx="800" cy="160" r="8" fill="#6b7280"/>
    <circle cx="800" cy="180" r="8" fill="#6b7280"/>
    <circle cx="800" cy="200" r="8" fill="#6b7280"/>
    
    <text x="800" y="165" font-family="Arial" font-size="11" text-anchor="middle" fill="#d1d5db">evidence-*.jpg</text>
    <text x="800" y="185" font-family="Arial" font-size="11" text-anchor="middle" fill="#d1d5db">verification-*.png</text>
    <text x="800" y="205" font-family="Arial" font-size="11" text-anchor="middle" fill="#d1d5db">(AES-256 encrypted)</text>
    
    <!-- Database -->
    <g id="database">
      <ellipse cx="800" cy="280" rx="80" ry="25" fill="#3b82f6" stroke="#1e40af" stroke-width="2"/>
      <path d="M 720 280 L 720 320 Q 720 345 800 345 Q 880 345 880 320 L 880 280" fill="#3b82f6" stroke="#1e40af" stroke-width="2"/>
      <ellipse cx="800" cy="320" rx="80" ry="25" fill="#60a5fa" stroke="#1e40af" stroke-width="2"/>
      
      <text x="800" y="310" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="white">Database</text>
      <text x="800" y="328" font-family="Arial" font-size="11" text-anchor="middle" fill="white">(Metadata Only)</text>
    </g>
    
    <!-- Arrow from Server to DB -->
    <path d="M 560 300 L 680 300" stroke="#374151" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>
    <text x="620" y="290" font-family="Arial" font-size="11" fill="#374151">Encrypted</text>
    <text x="620" y="318" font-family="Arial" font-size="11" fill="#6b7280">Metadata</text>
  </g>
  
  <!-- Section 3: What's Encrypted -->
  <g id="encrypted-data">
    <rect x="950" y="80" width="220" height="270" rx="8" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
    <text x="1060" y="110" font-family="Arial" font-size="16" font-weight="bold" text-anchor="middle" fill="#92400e">üîê Security Features</text>
    
    <text x="960" y="140" font-family="Arial" font-size="13" fill="#374151">‚úì AES-256-CBC encryption</text>
    <text x="960" y="162" font-family="Arial" font-size="13" fill="#374151">‚úì APP_KEY never leaves server</text>
    <text x="960" y="184" font-family="Arial" font-size="13" fill="#374151">‚úì Files encrypted at rest</text>
    <text x="960" y="206" font-family="Arial" font-size="13" fill="#374151">‚úì TLS 1.3 encrypts transit</text>
    <text x="960" y="228" font-family="Arial" font-size="13" fill="#374151">‚úì Role-based access control</text>
    <text x="960" y="250" font-family="Arial" font-size="13" fill="#374151">‚úì Audit logging enabled</text>
    <text x="960" y="272" font-family="Arial" font-size="13" fill="#374151">‚úì Private storage location</text>
    <text x="960" y="294" font-family="Arial" font-size="13" fill="#374151">‚úì No direct URL access</text>
    <text x="960" y="316" font-family="Arial" font-size="13" fill="#374151">‚úì Admin/Police only decrypt</text>
  </g>
  
  <!-- Section 4: Data Types Encrypted -->
  <g id="data-types">
    <rect x="50" y="420" width="520" height="180" rx="8" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/>
    <text x="310" y="450" font-family="Arial" font-size="16" font-weight="bold" text-anchor="middle" fill="#1e40af">Encrypted Data Types</text>
    
    <!-- Text Data -->
    <rect x="70" y="470" width="230" height="110" rx="6" fill="#fff" stroke="#3b82f6" stroke-width="2"/>
    <text x="185" y="492" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#1e40af">üìù Text Data (DB)</text>
    <text x="80" y="515" font-family="Arial" font-size="12" fill="#374151">‚Ä¢ Report description</text>
    <text x="80" y="535" font-family="Arial" font-size="12" fill="#374151">‚Ä¢ Barangay name</text>
    <text x="80" y="555" font-family="Arial" font-size="12" fill="#374151">‚Ä¢ Address</text>
    <text x="80" y="575" font-family="Arial" font-size="12" fill="#374151">‚Ä¢ Verification doc paths</text>
    
    <!-- File Data -->
    <rect x="320" y="470" width="230" height="110" rx="6" fill="#fff" stroke="#3b82f6" stroke-width="2"/>
    <text x="435" y="492" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#1e40af">üìÅ Files (Disk)</text>
    <text x="330" y="515" font-family="Arial" font-size="12" fill="#374151">‚Ä¢ Evidence photos/videos</text>
    <text x="330" y="535" font-family="Arial" font-size="12" fill="#374151">‚Ä¢ ID pictures</text>
    <text x="330" y="555" font-family="Arial" font-size="12" fill="#374151">‚Ä¢ Selfie with ID</text>
    <text x="330" y="575" font-family="Arial" font-size="12" fill="#374151">‚Ä¢ Billing documents</text>
  </g>
  
  <!-- Section 5: Retrieval Flow (Admin/Police) -->
  <text x="600" y="660" font-family="Arial" font-size="20" font-weight="bold" text-anchor="middle" fill="#1a1a1a">
    Document Retrieval (Admin/Police Only)
  </text>
  
  <g id="retrieval-section">
    <!-- Admin/Police -->
    <circle cx="1050" cy="750" r="50" fill="#dc2626" stroke="#991b1b" stroke-width="3"/>
    <text x="1050" y="745" font-family="Arial" font-size="14" fill="white" text-anchor="middle" font-weight="bold">Admin/</text>
    <text x="1050" y="762" font-family="Arial" font-size="14" fill="white" text-anchor="middle" font-weight="bold">Police</text>
    
    <!-- Arrow to Server -->
    <path d="M 1000 750 L 880 750" stroke="#374151" stroke-width="3" fill="none" marker-end="url(#arrowhead-left)"/>
    <text x="940" y="740" font-family="Arial" font-size="11" fill="#374151">Request</text>
    <text x="910" y="770" font-family="Arial" font-size="11" fill="#6b7280">with Auth</text>
    <text x="920" y="784" font-family="Arial" font-size="11" fill="#6b7280">via HTTPS</text>
    
    <!-- Laravel Server -->
    <rect x="580" y="680" width="280" height="180" rx="12" fill="#fff" stroke="#dc2626" stroke-width="3"/>
    <text x="720" y="710" font-family="Arial" font-size="18" font-weight="bold" text-anchor="middle" fill="#991b1b">Node.js Server</text>
    
    <!-- Role Check -->
    <rect x="600" y="725" width="240" height="45" rx="6" fill="#fee2e2" stroke="#dc2626" stroke-width="2"/>
    <text x="720" y="745" font-family="Arial" font-size="13" font-weight="bold" text-anchor="middle" fill="#991b1b">üîê Role Check</text>
    <text x="720" y="761" font-family="Arial" font-size="11" text-anchor="middle" fill="#7f1d1d">Admin or Police only</text>
    
    <!-- Decrypt File -->
    <rect x="600" y="780" width="240" height="55" rx="6" fill="#bbf7d0" stroke="#16a34a" stroke-width="2"/>
    <text x="720" y="800" font-family="Arial" font-size="14" font-weight="bold" text-anchor="middle" fill="#15803d">Decrypt File</text>
    <text x="720" y="818" font-family="Arial" font-size="11" text-anchor="middle" fill="#166534">Using APP_KEY</text>
    <text x="720" y="831" font-family="Arial" font-size="10" text-anchor="middle" fill="#166534">decryptFile(buffer)</text>
    
    <!-- Arrow from Storage -->
    <path d="M 480 750 L 560 750" stroke="#374151" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>
    <text x="520" y="740" font-family="Arial" font-size="11" fill="#374151">Read</text>
    <text x="495" y="770" font-family="Arial" font-size="11" fill="#6b7280">Encrypted</text>
    
    <!-- Private Storage (retrieval) -->
    <rect x="220" y="690" width="200" height="120" rx="8" fill="#1f2937" stroke="#111827" stroke-width="3"/>
    <text x="320" y="720" font-family="Arial" font-size="16" font-weight="bold" text-anchor="middle" fill="#fff">Private Storage</text>
    
    <circle cx="320" cy="750" r="8" fill="#6b7280"/>
    <circle cx="320" cy="780" r="8" fill="#6b7280"/>
    
    <text x="320" y="755" font-family="Arial" font-size="11" text-anchor="middle" fill="#d1d5db">üîí Encrypted files</text>
    <text x="320" y="785" font-family="Arial" font-size="11" text-anchor="middle" fill="#d1d5db">on disk</text>
  </g>
  
  <!-- Section 6: Flow Legend -->
  <g id="legend">
    <rect x="50" y="900" width="1120" height="180" rx="8" fill="#f3f4f6" stroke="#9ca3af" stroke-width="2"/>
    <text x="600" y="930" font-family="Arial" font-size="18" font-weight="bold" text-anchor="middle" fill="#1f2937">Complete Data Flow</text>
    
    <!-- Upload Flow -->
    <text x="70" y="960" font-family="Arial" font-size="14" font-weight="bold" fill="#1e40af">1. Upload:</text>
    <text x="70" y="980" font-family="Arial" font-size="12" fill="#374151">   Citizen ‚Üí HTTPS (plaintext) ‚Üí Node.js ‚Üí Encrypt(AES-256-CBC) ‚Üí Private Storage (encrypted files) + Database (encrypted metadata)</text>
    
    <!-- Storage -->
    <text x="70" y="1010" font-family="Arial" font-size="14" font-weight="bold" fill="#1e40af">2. Storage:</text>
    <text x="70" y="1030" font-family="Arial" font-size="12" fill="#374151">   Files: /evidence/*.jpg (encrypted with AES-256-CBC) | /verifications/*.png (encrypted with AES-256-CBC)</text>
    <text x="70" y="1048" font-family="Arial" font-size="12" fill="#374151">   Database: encrypted description, barangay, address, document paths | Lat/long stored unencrypted for geofencing</text>
    
    <!-- Retrieval -->
    <text x="70" y="1072" font-family="Arial" font-size="14" font-weight="bold" fill="#1e40af">3. Retrieval:</text>
    <text x="70" y="1092" font-family="Arial" font-size="12" fill="#374151">   Admin/Police ‚Üí Auth Check ‚Üí Read encrypted file ‚Üí Decrypt(APP_KEY) ‚Üí Send decrypted ‚Üí Admin sees plaintext</text>
  </g>
  
  <!-- Section 7: Implementation Details -->
  <g id="implementation">
    <rect x="50" y="1120" width="550" height="240" rx="8" fill="#ede9fe" stroke="#7c3aed" stroke-width="2"/>
    <text x="325" y="1150" font-family="Arial" font-size="16" font-weight="bold" text-anchor="middle" fill="#5b21b6">Implementation Details</text>
    
    <text x="70" y="1180" font-family="Arial" font-size="13" font-weight="bold" fill="#6b21a8">Encryption Algorithm:</text>
    <text x="70" y="1200" font-family="Arial" font-size="12" fill="#374151">‚Ä¢ AES-256-CBC (Cipher Block Chaining)</text>
    <text x="70" y="1218" font-family="Arial" font-size="12" fill="#374151">‚Ä¢ Random IV (16 bytes) per encryption</text>
    <text x="70" y="1236" font-family="Arial" font-size="12" fill="#374151">‚Ä¢ APP_KEY: 256-bit key from .env</text>
    
    <text x="70" y="1264" font-family="Arial" font-size="13" font-weight="bold" fill="#6b21a8">Files Encrypted:</text>
    <text x="70" y="1284" font-family="Arial" font-size="12" fill="#374151">‚Ä¢ handleReport.js: encryptFile() on evidence</text>
    <text x="70" y="1302" font-family="Arial" font-size="12" fill="#374151">‚Ä¢ handleNewFeatures.js: encryptFile() on verification docs</text>
    
    <text x="70" y="1330" font-family="Arial" font-size="13" font-weight="bold" fill="#6b21a8">Decryption Endpoints:</text>
    <text x="70" y="1350" font-family="Arial" font-size="12" fill="#374151">‚Ä¢ GET /evidence/:filename (Admin/Police only)</text>
  </g>
  
  <!-- Section 8: Access Control -->
  <g id="access-control">
    <rect x="620" y="1120" width="550" height="240" rx="8" fill="#fee2e2" stroke="#dc2626" stroke-width="2"/>
    <text x="895" y="1150" font-family="Arial" font-size="16" font-weight="bold" text-anchor="middle" fill="#991b1b">Access Control &amp; Security</text>
    
    <text x="640" y="1180" font-family="Arial" font-size="13" font-weight="bold" fill="#7f1d1d">Role-Based Access:</text>
    <text x="640" y="1200" font-family="Arial" font-size="12" fill="#374151">‚úì Citizens: Can upload (encrypted automatically)</text>
    <text x="640" y="1218" font-family="Arial" font-size="12" fill="#374151">‚úó Citizens: Cannot access encrypted files</text>
    <text x="640" y="1236" font-family="Arial" font-size="12" fill="#374151">‚úì Admin/Police: Full access with decryption</text>
    
    <text x="640" y="1264" font-family="Arial" font-size="13" font-weight="bold" fill="#7f1d1d">Protection Layers:</text>
    <text x="640" y="1284" font-family="Arial" font-size="12" fill="#374151">1. Encryption at Rest (AES-256-CBC)</text>
    <text x="640" y="1302" font-family="Arial" font-size="12" fill="#374151">2. Encryption in Transit (TLS 1.3 / HTTPS)</text>
    <text x="640" y="1320" font-family="Arial" font-size="12" fill="#374151">3. Authentication Required (JWT/Session)</text>
    <text x="640" y="1338" font-family="Arial" font-size="12" fill="#374151">4. Role Authorization (Admin/Police check)</text>
  </g>
  
  <!-- Arrow Definitions -->
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#374151"/>
    </marker>
    <marker id="arrowhead-left" markerWidth="10" markerHeight="10" refX="1" refY="3" orient="auto">
      <polygon points="10 0, 0 3, 10 6" fill="#374151"/>
    </marker>
  </defs>
</svg>
