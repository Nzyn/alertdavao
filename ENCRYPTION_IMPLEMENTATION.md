# AES-256-CBC Encryption Implementation

## Overview
This system implements **AES-256-CBC encryption** for sensitive data as per the capstone requirement:

> **Objective 1.3.2.1**: To send incident reports while encrypting sensitive user data using Laravel's Crypt Facade for enhanced confidentiality and security.

## What Data is Encrypted?

### 1. Incident Reports
- **Description** - The detailed report description
- **Location** - Barangay name and reporter's address
- **Data Flow**:
  - âœ… Encrypted on submission (UserSide)
  - ğŸ”’ Stored encrypted in database
  - ğŸ”“ Decrypted ONLY for police/admin roles

### 2. Verification Documents
- **id_picture** - Government ID photo path
- **id_selfie** - Selfie with ID path
- **billing_document** - Proof of address path
- **Data Flow**:
  - âœ… Encrypted paths before storage
  - ğŸ”’ Stored encrypted in database
  - ğŸ”“ Decrypted ONLY for admin roles reviewing verification

## Encryption Algorithm

**Algorithm**: AES-256-CBC (Advanced Encryption Standard with 256-bit key in Cipher Block Chaining mode)

### Why AES-256-CBC?
- âœ… **Industry Standard**: Used by banks, governments, and military
- âœ… **Highly Secure**: 256-bit key = 2^256 possible combinations
- âœ… **Laravel Compatible**: Laravel's `Crypt` facade uses AES-256-CBC by default
- âœ… **FIPS Compliant**: Approved by US National Institute of Standards and Technology

### Key Management
- **Encryption Key**: Stored in Laravel's `APP_KEY` environment variable
- **Key Format**: `base64:...` (automatically generated by Laravel)
- **Key Rotation**: Can be rotated using `php artisan key:generate`
- **Security**: Key is NEVER committed to Git (in `.env` file)

## Implementation Details

### UserSide Backend (Node.js)

**File**: `UserSide/backends/encryptionService.js`

```javascript
const { encrypt, decrypt, canDecrypt } = require('./encryptionService');

// Encrypt before storing
const encryptedDescription = encrypt(description);

// Decrypt for authorized roles only
if (canDecrypt(userRole)) {
    const decryptedDescription = decrypt(encryptedDescription);
}
```

**Key Functions**:
- `encrypt(text)` - Encrypt plain text
- `decrypt(encryptedText)` - Decrypt encrypted text
- `encryptFile(buffer)` - Encrypt file content
- `decryptFile(buffer)` - Decrypt file content
- `canDecrypt(userRole)` - Check if role can decrypt

### AdminSide Backend (Laravel PHP)

**File**: `AdminSide/admin/app/Services/EncryptionService.php`

```php
use App\Services\EncryptionService;

// Encrypt before storing
$encryptedDescription = EncryptionService::encrypt($description);

// Decrypt for authorized roles
if (EncryptionService::canDecrypt($userRole)) {
    $decryptedDescription = EncryptionService::decrypt($encryptedDescription);
}
```

**Key Methods**:
- `encrypt($text)` - Encrypt using Laravel Crypt
- `decrypt($encryptedText)` - Decrypt using Laravel Crypt
- `encryptFields($array, $fields)` - Encrypt multiple fields
- `decryptFields($array, $fields)` - Decrypt multiple fields
- `canDecrypt($userRole)` - Check authorization

## Role-Based Decryption

### Authorized Roles (Can Decrypt)
- âœ… **police** - Can view decrypted reports for their station
- âœ… **admin** - Can view all decrypted reports and verifications
- âœ… **superadmin** - Full access to all encrypted data

### Unauthorized Roles (Cannot Decrypt)
- âŒ **user** - Regular citizens (can only decrypt their own submissions)
- âŒ **guest** - Unauthenticated users

### Access Control Flow

```
User submits report
    â†“
Backend encrypts description & location
    â†“
Stored in database (encrypted)
    â†“
Police/Admin requests reports
    â†“
Backend checks role: canDecrypt(role)?
    â”œâ”€ YES (police/admin) â†’ Decrypt and return
    â””â”€ NO (user/guest) â†’ Return encrypted (unreadable)
```

## Database Storage

### Reports Table
```sql
CREATE TABLE reports (
    report_id INT PRIMARY KEY,
    description LONGTEXT,  -- ENCRYPTED âœ…
    ...
);
```

### Locations Table
```sql
CREATE TABLE locations (
    location_id INT PRIMARY KEY,
    barangay VARCHAR(255),        -- ENCRYPTED âœ…
    reporters_address TEXT,       -- ENCRYPTED âœ…
    ...
);
```

### Verifications Table
```sql
CREATE TABLE verifications (
    verification_id INT PRIMARY KEY,
    id_picture VARCHAR(255),      -- ENCRYPTED âœ…
    id_selfie VARCHAR(255),       -- ENCRYPTED âœ…
    billing_document VARCHAR(255), -- ENCRYPTED âœ…
    ...
);
```

## API Endpoints with Encryption

### Submit Report (Encrypts)
```http
POST /api/reports
Content-Type: multipart/form-data

{
    "description": "Plain text description",  
    "barangay": "Poblacion",
    ...
}

â†’ Stored as:
{
    "description": "eyJpdiI6Ik...",  # ENCRYPTED
    "barangay": "eyJpdiI6Ik...",     # ENCRYPTED
}
```

### Get Reports (Decrypts for Police/Admin)
```http
GET /api/reports?role=police

Response for police/admin:
{
    "description": "Plain text description",  # DECRYPTED
    "location": {
        "barangay": "Poblacion"              # DECRYPTED
    }
}

Response for regular user:
{
    "description": "eyJpdiI6Ik...",  # ENCRYPTED (unreadable)
    "location": {
        "barangay": "eyJpdiI6Ik..."  # ENCRYPTED (unreadable)
    }
}
```

## Security Benefits

### 1. Data Confidentiality
- âœ… Sensitive information protected at rest
- âœ… Database compromise doesn't reveal plain text
- âœ… Only authorized personnel can read sensitive data

### 2. Privacy Protection
- âœ… Reporter's location privacy maintained
- âœ… Verification documents secured
- âœ… Prevents unauthorized access to personal information

### 3. Compliance
- âœ… Meets data protection requirements
- âœ… Follows security best practices
- âœ… Satisfies capstone encryption objective

## Testing Encryption

### Test 1: Report Submission
```bash
# Submit a report
curl -X POST http://localhost:3000/api/reports \
  -F "description=Test incident" \
  -F "user_id=1" \
  ...

# Check database - description should be encrypted
mysql> SELECT description FROM reports ORDER BY report_id DESC LIMIT 1;
# Output: eyJpdiI6IlR4... (base64 encrypted data)
```

### Test 2: Role-Based Decryption
```bash
# Get reports as regular user
curl http://localhost:3000/api/reports?role=user
# description: "eyJpdiI6..." (encrypted)

# Get reports as police
curl http://localhost:3000/api/reports?role=police
# description: "Test incident" (decrypted)
```

## Console Logs

When encryption/decryption happens, you'll see:

```
ğŸ” Encrypting sensitive report data using AES-256-CBC...
âœ… Report created with ID: 123

ğŸ”“ Decrypting report 123 for authorized role: police
ğŸ”’ Keeping report 124 encrypted for role: user
```

## File Structure

```
UserSide/backends/
â”œâ”€â”€ encryptionService.js       # Node.js encryption service
â”œâ”€â”€ handleReport.js            # Uses encryption for reports
â””â”€â”€ handleNewFeatures.js       # Uses encryption for verifications

AdminSide/admin/app/
â””â”€â”€ Services/
    â””â”€â”€ EncryptionService.php  # Laravel encryption service
```

## Key Points for Capstone Defense

1. **Algorithm**: AES-256-CBC (industry standard)
2. **Implementation**: Laravel Crypt facade + Node.js crypto module
3. **Scope**: Encrypts reports (description, location) and verification documents
4. **Access Control**: Only police/admin roles can decrypt
5. **Security**: Encryption key stored in environment variable (not in code)
6. **Compatibility**: Both frontend (Node.js) and backend (Laravel) use same algorithm

## References

- [Laravel Encryption Documentation](https://laravel.com/docs/encryption)
- [Node.js Crypto Module](https://nodejs.org/api/crypto.html)
- [NIST AES Standard](https://csrc.nist.gov/publications/detail/fips/197/final)
